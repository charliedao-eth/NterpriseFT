---
title: "World of Women MVP"
author: "CharlieDAO NterpriseFT"
output: html_document
---

```{r include=FALSE}
knitr::opts_chunk$set(
	echo = TRUE,
	message = FALSE,
	warning = FALSE
)
# prepare env
library(dplyr)
library(reshape)
library(ggplot2)
library(kableExtra)

# loading helper functions
helperFunctionPath <- ('functions/helper_functions/')
sapply(list.files(pattern='[.]R$', path=helperFunctionPath, full.names=TRUE), source)

visualsFunctionsPath <- ('functions/visuals_functions/')
sapply(list.files(pattern='[.]R$', path=visualsFunctionsPath, full.names=TRUE), source)
```

```{r include=FALSE}
# load data
getLatestDataFromGithub()
```

```{r include=FALSE}
#######################
# UPDATE THESE VALUES #
#######################

nftName = 'World of Women'

# social data
twitterHistory <- wow_history
twitterRawPrimary <- wow_tweets_primary
twitterRawAll <- wow_tweets_all
twitterUserId <- '1414218489276125185'

# sales data
nftSales <- wow_sales
```

# Summary Page

-   Social Cards

    -   New Twitter SIdeBar Followers This For Week
    -   Number of Tweets Made
    -   Likes, Retweets, Replies

-   Sales Cards

    -   Number of Sales
    -   Median Sales Price
    -   Rolling Median Sales Price

-   Ownsership Cards

    -   Number of New Owners
    -   Gini Coefficient of Holders
    -   Max, Avg, Median Number Held

-   Executive Summary (Parameterized Paragraph)

Twitter growth was [ABOVE \| BELOW] expected this. There are [\#\#] new followers while [ \#\# ] new followers was expected. Total engagement was [UP \| DOWN] [ %] week over week. The median sales price is [UP \| DOWN] to [\#\#] ETH. With [\#\#] sales this week, Volume is [UP \| DOWN] [%] week over week.

The \# of unique holders is [UP\|DOWN] week over week. The inequality of \# of NFTs owned is [UP \| DOWN] week over week. Your NFT is primarily held alongside [\#1 Competitor] [\#2 competitor][\#3 competitor].

Gas fees averaged [\#\#] gwei over the past week, and sales [OVER \| UNDER]performed relative to gas with [\#\#] sales versus expected [\#\#] given gas fees.

# Social Stats

1.  Twitter Followers over time

    ```{r echo=FALSE}
    createNftTimeSeriesPlot(
      dataframe=twitterHistory,
      dateCol='date',
      outcomeCols='followers',
      nftName=nftName,
      title='Twitter Followers Over Time',
      lowerQuantile=0.00,
      upperQuantile=1.00,
      imputeData=TRUE,
      geomLine=TRUE,
      logScale=FALSE,
      savePlotData=FALSE
    )
    ```

2.  DELTA Twitter Followers over time (vs expected)

3.  Likes/RTs over time

    ```{r echo=FALSE}
    twitterRawPrimarySummary <- twitterRawPrimary %>%
      mutate(date = as.Date(primary_tweets.created_at)) %>%
      group_by(date) %>%
      summarise(
        totalLikes = sum(primary_tweets.favorite_count),
        totalRetweets = sum(primary_tweets.retweet_count)
      )

    createNftTimeSeriesPlot(
      dataframe=twitterRawPrimarySummary,
      dateCol='date',
      outcomeCols=c('totalLikes', 'totalRetweets'),
      nftName=nftName,
      title='Twitter Engagement Over Time',
      lowerQuantile=0.00,
      upperQuantile=1.00,
      imputeData=TRUE,
      geomLine=TRUE,
      logScale=FALSE,
      savePlotData=FALSE
    )
    ```

4.  Engagement Score over time

    ```{r echo=FALSE}
    twitterMedianEngagementScore <- twitterRawPrimary %>%
      mutate(date = as.Date(primary_tweets.created_at)) %>%
      mutate(
        engagementScore = (1+primary_tweets.favorite_count)*(1+primary_tweets.retweet_count)
        ) %>%
      group_by(date) %>%
      summarise(
        medianEngagementScore = median(engagementScore),
      )

    createNftTimeSeriesPlot(
      dataframe=twitterMedianEngagementScore,
      dateCol='date',
      outcomeCols='medianEngagementScore',
      nftName=nftName,
      title='Median Engagement Score Over Time',
      lowerQuantile=0.00,
      upperQuantile=1.00,
      imputeData=TRUE,
      geomLine=TRUE,
      logScale=FALSE,
      savePlotData=FALSE
    )
    ```

5.  Tweets from main account

    ```{r include=FALSE}
    # prepare twitter data
    twitterRawAllFilter <- twitterRawAll %>%
      filter(
        all_tweets.user_id == twitterUserId,
        all_tweets.is_retweet == FALSE,
      ) %>%
      mutate(
        engagementScore = (all_tweets.favorite_count+1)*(all_tweets.retweet_count+1)
      ) %>%
      mutate(
        timestamp = as.POSIXct(all_tweets.created_at, format="%Y-%m-%d %H:%M:%S", tz="UTC")
      ) %>%
      dplyr::rename(
        screenName = all_tweets.screen_name,
        tweetUrl = all_tweets.status_url,
        favoriteCount = all_tweets.favorite_count,
        retweetCount = all_tweets.retweet_count
      ) %>%
      select(
        screenName,
        timestamp,
        tweetUrl,
        favoriteCount,
        retweetCount,
        engagementScore
      )

    # get timeframes
    maxDate <- max(as.Date(twitterRawAllFilter$timestamp))
    weekStartDate <- maxDate - as.difftime(7, unit='days')
    ```

    -   Top 5 Tweets All time

    ```{r echo=FALSE}
    # top 5 all time
    topFiveTweetsAll <- twitterRawAllFilter %>%
      arrange(desc(engagementScore)) %>%
      slice_head(n=5)

    topFiveTweetsAll %>%
      kbl() %>%
      kable_material('striped')
    ```

    -   Top 5 Tweets of the week

    ```{r echo=FALSE}
    # top 5 past week
    topFiveTweetsWeek <- twitterRawAllFilter %>%
      filter(between(as.Date(timestamp), weekStartDate, maxDate)) %>%
      arrange(desc(engagementScore)) %>%
      slice_head(n=5)

    topFiveTweetsWeek %>%
      kbl() %>%
      kable_material('striped')
    ```

6.  Tweets of others (out of scope for MVP)

    -   Top 5 Account that's retweeted the main NFT account the most all time

    -   Top 5 Accounts with the highest engagement all time for their retweets

    -   Top 5 retweets for the week between interquartile range Q2 and Q3 for engagement score (i.e. these are the tweets that were probably missed by the main account, but have solid reach with more room to grow; great for the main account to engage with).

# Sales Stats (exclude outlier sales)

```{r include=FALSE}
# returns date, min_price, median_price, max_price, and total_sales
typicalSalesDf <- getTypicalDailySalesPrice(
  dataframe=nftSales,
  dateCol='BLOCK_TIMESTAMP',
  priceCol='PRICE'
)

# returns date, sales_count, sales_count_sum
dailySalesCountDf <- getDailySalesCount(
  dataframe=nftSales,
  dateCol='BLOCK_TIMESTAMP'
)

# get top 5 tweets all time dates
topTenTweetsAll <- twitterRawAllFilter %>%
  arrange(desc(engagementScore)) %>%
  slice_head(n=10)

topTenTweetsAllDateList <- unique(as.Date(topTenTweetsAll$timestamp))

topTenTweetsPlot <- geom_vline(
  xintercept=as.numeric(topTenTweetsAllDateList),
  linetype=4,
  colour='black'
  )
```

1.  Typical sales price

    ```{r echo=FALSE}
    # all sales values
    allSalesValuesPlot <- createNftTimeSeriesPlot(
        dataframe=typicalSalesDf,
        dateCol='date',
        outcomeCols=c('min_price', 'median_price', 'max_price'),
        nftName=nftName,
        title='Typical ETH Sales Price Over Time w/ Top 10 Tweets',
        lowerQuantile=0.00,
        upperQuantile=0.97,
        imputeData=TRUE,
        geomLine=TRUE,
        logScale=FALSE,
        savePlotData=FALSE
      )

    allSalesValuesPlot + topTenTweetsPlot
    ```

    ```{r echo=FALSE}
    # min sales values
    minSalesPlot <- createNftTimeSeriesPlot(
        dataframe=typicalSalesDf,
        dateCol='date',
        outcomeCols='min_price',
        nftName=nftName,
        title='Min ETH Sales Price Over Time w/ Top 10 Tweets',
        lowerQuantile=0.00,
        upperQuantile=0.97,
        imputeData=TRUE,
        geomLine=TRUE,
        logScale=FALSE,
        savePlotData=FALSE
      )

    minSalesPlot + topTenTweetsPlot
    ```

    ```{r echo=FALSE}
    # median sales values
    medianSalesPlot <- createNftTimeSeriesPlot(
        dataframe=typicalSalesDf,
        dateCol='date',
        outcomeCols='median_price',
        nftName=nftName,
        title='Median ETH Sales Price Over Time w/ Top 10 Tweets',
        lowerQuantile=0.00,
        upperQuantile=0.97,
        imputeData=TRUE,
        geomLine=TRUE,
        logScale=FALSE,
        savePlotData=FALSE
      )

    medianSalesPlot + topTenTweetsPlot
    ```

    ```{r echo=FALSE}
    # max sales values
    maxSalesPlot <- createNftTimeSeriesPlot(
        dataframe=typicalSalesDf,
        dateCol='date',
        outcomeCols='max_price',
        nftName=nftName,
        title='Max ETH Sales Price Over Time w/ Top 10 Tweets',
        lowerQuantile=0.00,
        upperQuantile=0.97,
        imputeData=TRUE,
        geomLine=TRUE,
        logScale=FALSE,
        savePlotData=FALSE
      )

    maxSalesPlot + topTenTweetsPlot
    ```

    ```{r echo=FALSE}
    # total sales values
    totalSalesPlot <- createNftTimeSeriesPlot(
        dataframe=typicalSalesDf,
        dateCol='date',
        outcomeCols='total_sales',
        nftName=nftName,
        title='Total Daily ETH Sales Over Time w/ Top 10 Tweets',
        lowerQuantile=0.00,
        upperQuantile=0.97,
        imputeData=TRUE,
        geomLine=TRUE,
        logScale=FALSE,
        savePlotData=FALSE
      )

    totalSalesPlot + topTenTweetsPlot
    ```

2.  Sales table

    ```{r echo=FALSE}
    lastWeekSalesTable <- typicalSalesDf %>%
      arrange(desc(date)) %>%
      slice_head(n=7)

    lastWeekSalesTable %>%
      kbl() %>%
      kable_material('striped')
    ```

3.  Volume of sales over time

    ```{r echo=FALSE}
    createNftTimeSeriesPlot(
        dataframe=dailySalesCountDf,
        dateCol='date',
        outcomeCols='sales_count_sum',
        nftName=nftName,
        title='Sales Count Sum Over Time',
        lowerQuantile=0.00,
        upperQuantile=1.00,
        imputeData=TRUE,
        geomLine=TRUE,
        logScale=FALSE,
        savePlotData=FALSE
    )
    ```

    ```{r echo=FALSE}
    salesCountPlot <- createNftTimeSeriesPlot(
        dataframe=dailySalesCountDf,
        dateCol='date',
        outcomeCols='sales_count',
        nftName=nftName,
        title='Sales Count Over Time w/ Top 10 Tweets',
        lowerQuantile=0.00,
        upperQuantile=1.00,
        imputeData=TRUE,
        geomLine=TRUE,
        logScale=FALSE,
        savePlotData=FALSE
      )

    salesCountPlot + topTenTweetsPlot
    ```

4.  daily volume and avg gas cost (gwei) per date

    ```{r echo=FALSE}
    gasDf <- etherscan_average_daily_gas_attribute %>%
        mutate(date = as.Date(Date.UTC., format='%m/%d/%Y')) %>%
        mutate(avg_gwei = Value..Wei.) %>%
        filter(avg_gwei > 0) %>%
        select(date, avg_gwei)
      
    gasSalesDf <- dailySalesCountDf %>%
      inner_join(gasDf, by='date')

    gasPlot <- ggplot(
          gasSalesDf,
          aes(x = avg_gwei, y = sales_count)
        ) +
          geom_point(alpha = 1/5) +
          labs(
            title = 'Average Gas Price v.s. Number of NFT Sales by Day',
            subtitle = nftName,
            caption = '*Each point represents a single date.',
            x='Average Gas Price (Gwei)',
            y='Number of Sales'
          )

        gasPlot
    ```

5.  All Eth Sales

    ```{r echo=FALSE}
    createNftTimeSeriesPlot(
        dataframe=nftSales,
        dateCol='BLOCK_TIMESTAMP',
        outcomeCols='PRICE',
        nftName=nftName,
        title='All ETH Sales Over Time',
        lowerQuantile=0.00,
        upperQuantile=0.99,
        imputeData=FALSE,
        geomLine=FALSE,
        logScale=FALSE,
        savePlotData=FALSE
      )
    ```

# Ownership Stats

1.  Number owned boxplot
2.  Top owners table with wallet id and number owned
3.  Number of unique holders over time (derived from sales and transfers)
4.  Gini coefficient over time
5.  NFT Co-occurance in wallets (network)
